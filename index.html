<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¦ãƒå¨˜ã‚’æã“ã†ğŸ¨</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 5px; }
    #resultTitle { margin-top: 20px; font-size: 20px; font-weight: bold; }
    #result { font-size: 24px; font-weight: bold; margin-top: 5px; }
    #history { margin-top: 10px; }
    #history li { margin-bottom: 5px; }
    #historyTitle { margin-top: 30px; font-weight: bold; font-size: 18px; }
  </style>
</head>
<body>
  <h1>ã‚¦ãƒå¨˜ã‚’æã“ã†ğŸ¨</h1>
  <button id="drawBtn">ä»Šæ—¥ã®ä¸€äººï¼</button>

  <div id="resultTitle"></div>
  <div id="result"></div>

  <div id="historyTitle">ã‚Šã‚Œã</div>
  <ul id="history"></ul>
  
  <div>
    <input type="checkbox" id="confirmClear">
    <label for="confirmClear">å±¥æ­´ã‚’åˆæœŸåŒ–ã§ãã¾ã™</label>
    <button id="clearBtn">å±¥æ­´ã‚’æ¶ˆã™</button>
  </div>

  <script>
    let names = [];
    let allNames = [];
    let historyList = [];

    const drawBtn = document.getElementById("drawBtn");
    const resultTitle = document.getElementById("resultTitle");
    const resultDiv = document.getElementById("result");
    const historyUl = document.getElementById("history");
    const clearBtn = document.getElementById("clearBtn");
    const confirmClear = document.getElementById("confirmClear");

    // åˆæœŸåŒ–
    resultTitle.textContent = "";
    resultDiv.textContent = "";

    // JSONã‚’èª­ã¿è¾¼ã‚€
    fetch("names.json")
      .then(response => response.json())
      .then(data => {
        allNames = [...data.names]; // å…ƒã®åå‰ãƒªã‚¹ãƒˆã‚’ä¿æŒ
        names = [...allNames];

        // localStorageã«å±¥æ­´ãŒã‚ã‚Œã°å¾©å…ƒ
        const savedHistory = localStorage.getItem('history');
        if(savedHistory) {
          historyList = JSON.parse(savedHistory);
          updateHistory();
          // åå‰ãƒªã‚¹ãƒˆã‹ã‚‰å±¥æ­´åˆ†ã‚’é™¤å¤–
          historyList.forEach(item => {
            const idx = names.indexOf(item.name);
            if(idx !== -1) names.splice(idx, 1);
          });
        }
      })
      .catch(err => console.error("èª­ã¿è¾¼ã¿å¤±æ•—:", err));

    drawBtn.addEventListener("click", () => {
      if(names.length === 0) {
        resultTitle.textContent = "";
        resultDiv.textContent = "ã‚‚ã†æŠ½é¸ã§ãã‚‹äººãŒã„ã¾ã›ã‚“ï¼";
        return;
      }

      resultTitle.textContent = "";
      resultDiv.textContent = "æŠ½é¸ä¸­â€¦";

      setTimeout(() => {
        const idx = Math.floor(Math.random() * names.length);
        const winner = names.splice(idx, 1)[0];

        // æ™‚é–“ã‚’ yyyy/mm/dd hh:mm å½¢å¼ã§ä½œæˆ
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeStr = `${year}/${month}/${day} ${hours}:${minutes}`;

        historyList.unshift({ name: winner, time: timeStr });
        localStorage.setItem('history', JSON.stringify(historyList));

        resultTitle.textContent = "ä»Šæ—¥ã¯ã“ã®ã‚¦ãƒå¨˜ï¼";
        resultDiv.textContent = `ğŸ‰ ${winner} ğŸ‰ (${timeStr})`;
        updateHistory();
      }, 500);
    });

    clearBtn.addEventListener("click", () => {
      if(!confirmClear.checked) {
        alert("ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‹ã‚‰åˆæœŸåŒ–ã—ã¦ãã ã•ã„");
        return;
      }
      if(confirm("æœ¬å½“ã«å±¥æ­´ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
        historyList = [];
        localStorage.removeItem('history');
        names = [...allNames]; // å…¨å“¡å¾©æ´»
        resultTitle.textContent = "";
        resultDiv.textContent = "";
        updateHistory();
        alert("å±¥æ­´ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ");
      }
    });

    function updateHistory() {
      historyUl.innerHTML = "";
      historyList.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.name} (${item.time})`;
        historyUl.appendChild(li);
      });
    }
  </script>
</body>
</html>
